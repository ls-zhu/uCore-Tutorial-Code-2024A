# uCore Lab2 实验报告
姓名：祝令山 学号：2024319220
## 功能总结
1. 重新实现 sys_gettimeofday以及 taskinfo：因为ch4支持虚拟内存、页表隔离，所以用户态程序和内内核态程序不在一个地址空间，所以需要使用copyout()和copyin()进行跨地址空间的内存复制  

2. 实现int mmap(void* start, unsigned long long len, int port, int flag, int fd)：系统调用id 222，分配len大小的内存，并映射到某个的指定的start地址，实现如下:  
2.1 检查参数正确性：len是否为0或者过大，start是否页对齐，port设置是否合法  
2.2 检测某个处于[start, start + len]中的va是否已经被映射过
2.3 使用kalloc()分配一个页面，因为这个页面必须有效，必须对用户态可见，所以设置页面属性为PTE_V | PTE_U。根据port设置页面属性是否可读(PTE_R)、可写(PTE_W)、可执行(PTE_X)  
2.4 使用mappages()函数将这个页面映射到va地址，其中页表为curr_proc()->pagetable。  
2.5 如果len大于一个页面，则循环执行2.2到2.4  

3. 实现int munmap(void* start, unsigned long long len)，系统调用id 215，用来取消一块内存映射，实现如下：  
3.1 校验start是否页对齐  
3.2 通过walk()函数得到pte，校验pte是否有效、正确  
3.3 通过uvmunmap()函数unmap并且释放页面  
3.4 如果len大于一个页面，则循环执行3.2和3.4  

## 作业问答  
1. 由risc-v spec 《The RISC-V Instruction Set Manual: Volume II Privileged Architecture》 10.3.1章节可知，SV39(和SV32一致)的标志位及其作用如下：  
bit0: PTE_V 如果为1，则该页有效。  
bit1: PTE_R 读权限，如果为1，则该页可读。  
bit2：PTE_W 写权限，如果为1，则该页可写。  
bit3：PTE_X 执行权限，如果为1，则该页内容可执行。  
bit4：PTE_U 用户态访问权限，如果为1，则该页可被用户态访问。  
bit5：PTE_A access位，如果为1，说明该页被访问过。可以用来监测页面的冷热程度，用于迁移页面或者swap out  
bit6：PTE_D dirty位，如果为1，说明该页被写过。可以用来检测脏页  
bit7：PTE_G global mapping位，如果为1，则该页在所有地址空间内都有效。

2. 缺页  
2.1 请问哪些异常可能是缺页导致的？  
答：由risc-v spec可知，Load Page Fault和Instruction Page Fault可能是由缺页导致的。  
2.2 发生缺页时，描述相关的重要寄存器的值  
答：SCAUSE寄存器：描述了异常由缺页导致，比如Load page fault、Store/AMO page fault和Instruction page fault。   
STVAL：page fault地址。  
trapframe中的epc：发生page fault的指令。OS处理完page fault异常用要从epc继续运行用户态程序  
2.3 Lzay策略的好处  
答：Lazy策略意味着按需加载代码和数据页面，可以节约物理内存，避免无意义的加载，提高启动速度  
2.4请问处理 10G 连续的内存页面，需要操作的页表实际大致占用多少内存(给出数量级即可)？  
答：一个页大小为4k，10G内存需要2,621,440个页面。每个PTE为8byte，所以10G内存需要20,971,520bytes来存储pte，忽略三级页表本身所占的少数page，可以得到10GB内存所需要的页表内存约为20M。  
2.5 请简单思考如何才能在现有框架基础上实现 Lazy 策略，缺页时又如何处理？  
答：程序运行时只加载最初的代码和数据，但是创建完整的地址空间和页表。一旦出现page fault则按需加载页面，除了加载产生page fault的页面之外，还可以考虑预读，即根据程序的局部性原理，额外加载一定量的页面，以提高性能，减少page fault次数。  
2.6 缺页的另一个常见原因是 swap 策略，也就是内存页面可能被换到磁盘上了，导致对应页面失效。此时页面失效如何表现在页表项(PTE)上？  
答：此时页面的PTE_V应该被清零  

3. 双页表与单页表  
3.1 单页表情况下，如何更换页表？  
答：通过切换satp来更换页表  
3.2 单页表情况下，如何控制用户态无法访问内核页面？  
答：将内核页面的PTE_U设置为0  
3.3 单页表有何优势？  
答：单页表实现简单，切换速度也快一些   
3.4 双页表实现下，何时需要更换页表？假设你写一个单页表操作系统，你会选择何时更换页表  
答：双页表实现下，会在程序执行流程在用户态时候切换到用户态页表，当需要内核态支持的时候切换到内核态页表。单页表操作系统应该在切换任务的时候切换页表

# 荣誉准则
1. 在完成本次实验的过程（含此前学习的过程）中，我曾分别与 以下各位 就（与本次实验相关的）以下方面做过交流，还在代码中对应的位置以注释形式记录了具体的交流对象及内容：
>无
2. 此外，我也参考了 以下资料 ，还在代码中对应的位置以注释形式记录了具体的参考来源及内容：
> 《The RISC-V Instruction Set Manual: Volume II Privileged Architecture》
3. 我独立完成了本次实验除以上方面之外的所有工作，包括代码与文档。 我清楚地知道，从以上方面获得的信息在一定程度上降低了实验难度，可能会影响起评分。
4. 我从未使用过他人的代码，不管是原封不动地复制，还是经过了某些等价转换。 我未曾也不会向他人（含此后各届同学）复制或公开我的实验代码，我有义务妥善保管好它们。 我提交至本实验的评测系统的代码，均无意于破坏或妨碍任何计算机系统的正常运转。 我清楚地知道，以上情况均为本课程纪律所禁止，若违反，对应的实验成绩将按“-100”分计。



